{% extends "base.html" %}

{% block content %}
<div class="controls-bar">
    <button class="btn btn-primary" id="btn-all-on">
        <span class="icon">‚ö°</span> Turn All On
    </button>
    <button class="btn btn-secondary" id="btn-all-off">
        <span class="icon">üîå</span> Turn All Off
    </button>
    <button class="btn btn-info" id="btn-refresh">
        <span class="icon">üîÑ</span> Refresh
    </button>
    <a href="/power-table" class="btn btn-power">
        <span class="icon">üìä</span> Power Table
    </a>
    <a href="/" class="btn btn-info" id="compact-toggle-link">
        <span class="icon">üì±</span> Compact Mode
    </a>
</div>

<div class="outlets-grid" id="outlets-grid">
    <div class="loading-message">
        <div class="spinner"></div>
        <p>Loading outlets...</p>
    </div>
</div>

<!-- Power Draw Modal -->
<div id="power-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="power-modal-title">Power Draw</h2>
        <div id="power-modal-body">
            <div class="loading-message">
                <div class="spinner"></div>
                <p>Loading power data...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Check for compact mode (for Raspberry Pi 5" screen)
    (function() {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const isCompact = 
            params.get('compact') === 'true' ||
            params.get('compact-mode') === 'true' ||
            params.get('pi') === 'true';

        if (isCompact) {
            document.body.classList.add('compact-mode');
        }

        const compactLink = document.getElementById('compact-toggle-link');
        if (compactLink) {
            if (isCompact) {
                // We are in compact mode now so link should go to normal mode
                params.delete('compact');
                params.delete('compact-mode');
                params.delete('pi');
                
                const normalUrl = url.pathname + (params.toString() ? '?' + params.toString() : '');
                compactLink.href = normalUrl;
                compactLink.innerHTML = '<span class="icon">üñ•Ô∏è</span> Standard Mode';
            } else {
                // We are in normal mode now so the link should go to compact mode
                params.set('compact', 'true');
                const compactUrl = url.pathname + (params.toString() ? '?' + params.toString() : '');
                compactLink.href = compactUrl;
                compactLink.innerHTML = '<span class="icon">üì±</span> Compact Mode';
            }
        }
    })();
    
    // Wait for main.js to load before initializing
    let retryCount = 0;
    const maxRetries = 3; // 5 seconds max wait time
    
    function initializeApp() {
        console.log('DOMContentLoaded fired');
        console.log('loadOutlets function:', typeof loadOutlets);
        
        if (typeof loadOutlets !== 'function') {
            retryCount++;
            if (retryCount >= maxRetries) {
                console.error('loadOutlets is not defined after ' + maxRetries + ' retries!');
                const grid = document.getElementById('outlets-grid');
                if (grid) {
                    grid.innerHTML = '<div class="error-message">Error: Failed to load main.js. Please refresh the page.</div>';
                }
                return;
            }
            console.warn('loadOutlets is not defined! Retrying in 100ms... (attempt ' + retryCount + '/' + maxRetries + ')');
            setTimeout(initializeApp, 100);
            return;
        }
        
        console.log('main.js loaded successfully, initializing app...');
        
        // Load outlets on page load
        loadOutlets();
        
        // Refresh button
        const refreshBtn = document.getElementById('btn-refresh');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('Refresh button clicked');
                loadOutlets();
            });
        }
        
        // Turn all on/off buttons
        const allOnBtn = document.getElementById('btn-all-on');
        if (allOnBtn) {
            allOnBtn.addEventListener('click', function() {
                if (typeof toggleAllOutlets === 'function') {
                    toggleAllOutlets('on');
                } else {
                    console.error('toggleAllOutlets is not defined');
                }
            });
        }
        
        const allOffBtn = document.getElementById('btn-all-off');
        if (allOffBtn) {
            allOffBtn.addEventListener('click', function() {
                if (typeof toggleAllOutlets === 'function') {
                    toggleAllOutlets('off');
                } else {
                    console.error('toggleAllOutlets is not defined');
                }
            });
        }
        
        // Modal close button
        const modal = document.getElementById('power-modal');
        const closeBtn = document.getElementsByClassName('close')[0];
        
        if (closeBtn && modal) {
            closeBtn.onclick = function() {
                modal.style.display = 'none';
            };
        }
        
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        // DOM is already ready
        initializeApp();
    }
</script>
{% endblock %}

