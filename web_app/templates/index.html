{% extends "base.html" %}

{% block content %}
<div class="controls-bar">
    <button class="btn btn-primary" id="btn-all-on">
        <span class="icon">‚ö°</span> Turn All On
    </button>
    <button class="btn btn-secondary" id="btn-all-off">
        <span class="icon">üîå</span> Turn All Off
    </button>
    <button class="btn btn-info" id="btn-refresh">
        <span class="icon">üîÑ</span> Refresh
    </button>
    <a href="/power-table" class="btn btn-power" id="power-table-link" data-preserve-compact>
        <span class="icon">üìä</span> Power Table
    </a>
    <a href="/" class="btn btn-info" id="compact-toggle-link">
        <span class="icon">üì±</span> Compact Mode!
    </a>
    <button class="btn btn-info" id="btn-settings">
        <span class="icon">‚öôÔ∏è</span> Settings
    </button>
</div>

<div class="outlets-grid" id="outlets-grid">
    <div class="loading-message">
        <div class="spinner"></div>
        <p>Loading outlets...</p>
    </div>
</div>

<!-- Power Draw Modal -->
<div id="power-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="power-modal-title">Power Draw</h2>
        <div id="power-modal-body">
            <div class="loading-message">
                <div class="spinner"></div>
                <p>Loading power data...</p>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close" id="settings-close">&times;</span>
        <h2>Power Strip Settings</h2>
        <div id="settings-modal-body">
            <div id="power-strips-list" style="margin-bottom: 20px;">
                <h3>Power Strips</h3>
                <div id="power-strips-container">
                    <div class="loading-message">Loading power strips...</div>
                </div>
                <button type="button" class="btn btn-primary" id="btn-add-power-strip" style="margin-top: 15px;">
                    <span class="icon">‚ûï</span> Add Power Strip
                </button>
            </div>
            
            <!-- Add/Edit Power Strip Form -->
            <div id="power-strip-form-container" style="display: none;">
                <h3 id="form-title">Add Power Strip</h3>
                <form id="power-strip-form">
                    <input type="hidden" id="form-power-strip-id" value="">
                    <div class="form-group">
                        <label for="form-power-strip-name">Name:</label>
                        <input type="text" id="form-power-strip-name" name="name" 
                               placeholder="e.g., Living Room Power Strip" required>
                        <small class="form-help">A friendly name to identify this power strip</small>
                    </div>
                    <div class="form-group">
                        <label for="form-power-strip-ip">IP Address:</label>
                        <input type="text" id="form-power-strip-ip" name="ip_address" 
                               placeholder="192.168.50.137" required 
                               pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$">
                        <small class="form-help">Enter the IP address of your TP-Link HS300 power strip</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="form-submit-btn">Save</button>
                        <button type="button" class="btn btn-secondary" id="form-cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
            
            <div id="settings-message" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Handle compact mode toggle and link updates
    (function() {
        // Wait for CompactMode utility to load
        function initCompactMode() {
            if (typeof window.CompactMode === 'undefined') {
                setTimeout(initCompactMode, 50);
                return;
            }
            
            const compactLink = document.getElementById('compact-toggle-link');
            if (compactLink) {
                const isCompact = window.CompactMode.isEnabled();
                
                // Update link text and href
                if (isCompact) {
                    compactLink.href = window.CompactMode.getUrl('/', false);
                    compactLink.innerHTML = '<span class="icon">üñ•Ô∏è</span> Standard Mode';
                } else {
                    compactLink.href = window.CompactMode.getUrl('/', true);
                    compactLink.innerHTML = '<span class="icon">üì±</span> Compact Mode';
                }
                
                // Add click handler to toggle and update
                compactLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newState = window.CompactMode.toggle();
                    
                    // Update link text
                    if (newState) {
                        compactLink.innerHTML = '<span class="icon">üñ•Ô∏è</span> Standard Mode';
                    } else {
                        compactLink.innerHTML = '<span class="icon">üì±</span> Compact Mode';
                    }
                    
                    // Update all links
                    window.CompactMode.updateLinks();
                    
                    // Navigate to the new URL
                    window.location.href = compactLink.href;
                });
            }
            
            // Update all links to preserve compact mode
            window.CompactMode.updateLinks();
        }
        
        initCompactMode();
    })();
    
    // Wait for main.js to load before initializing
    let retryCount = 0;
    const maxRetries = 3; // 5 seconds max wait time
    
    function initializeApp() {
        console.log('DOMContentLoaded fired');
        console.log('loadOutlets function:', typeof loadOutlets);
        
        if (typeof loadOutlets !== 'function') {
            retryCount++;
            if (retryCount >= maxRetries) {
                console.error('loadOutlets is not defined after ' + maxRetries + ' retries!');
                const grid = document.getElementById('outlets-grid');
                if (grid) {
                    grid.innerHTML = '<div class="error-message">Error: Failed to load main.js. Please refresh the page.</div>';
                }
                return;
            }
            console.warn('loadOutlets is not defined! Retrying in 100ms... (attempt ' + retryCount + '/' + maxRetries + ')');
            setTimeout(initializeApp, 100);
            return;
        }
        
        console.log('main.js loaded successfully, initializing app...');
        
        // Load outlets on page load
        loadOutlets();
        
        // Refresh button
        const refreshBtn = document.getElementById('btn-refresh');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('Refresh button clicked');
                loadOutlets();
            });
        }
        
        // Turn all on/off buttons
        const allOnBtn = document.getElementById('btn-all-on');
        if (allOnBtn) {
            allOnBtn.addEventListener('click', function() {
                if (typeof toggleAllOutlets === 'function') {
                    toggleAllOutlets('on');
                } else {
                    console.error('toggleAllOutlets is not defined');
                }
            });
        }
        
        const allOffBtn = document.getElementById('btn-all-off');
        if (allOffBtn) {
            allOffBtn.addEventListener('click', function() {
                if (typeof toggleAllOutlets === 'function') {
                    toggleAllOutlets('off');
                } else {
                    console.error('toggleAllOutlets is not defined');
                }
            });
        }
        
        // Power modal close button
        const powerModal = document.getElementById('power-modal');
        const powerCloseBtn = document.querySelector('#power-modal .close');
        
        if (powerCloseBtn && powerModal) {
            powerCloseBtn.onclick = function() {
                powerModal.style.display = 'none';
            };
        }
        
        window.onclick = function(event) {
            if (event.target == powerModal) {
                powerModal.style.display = 'none';
            }
        };
        
        // Settings modal - Power Strip Management
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('btn-settings');
        const settingsCloseBtn = document.getElementById('settings-close');
        const powerStripsContainer = document.getElementById('power-strips-container');
        const powerStripFormContainer = document.getElementById('power-strip-form-container');
        const powerStripForm = document.getElementById('power-strip-form');
        const formCancelBtn = document.getElementById('form-cancel-btn');
        const btnAddPowerStrip = document.getElementById('btn-add-power-strip');
        const settingsMessage = document.getElementById('settings-message');
        
        // Load and display power strips
        async function loadPowerStripsList() {
            if (!powerStripsContainer) return;
            
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success) {
                    const powerStrips = data.power_strips || [];
                    const activeId = data.active_power_strip_id;
                    
                    powerStripsContainer.innerHTML = '';
                    
                    if (powerStrips.length === 0) {
                        powerStripsContainer.innerHTML = '<p style="color: var(--text-secondary);">No power strips configured. Click "Add Power Strip" to get started.</p>';
                        return;
                    }
                    
                    powerStrips.forEach(ps => {
                        const item = document.createElement('div');
                        item.className = `power-strip-item ${ps.id === activeId ? 'active' : ''}`;
                        item.innerHTML = `
                            <div class="power-strip-item-info">
                                <div class="power-strip-item-name">${escapeHtml(ps.name)}</div>
                                <div class="power-strip-item-ip">${escapeHtml(ps.ip_address)}</div>
                            </div>
                            <div class="power-strip-item-actions">
                                <button class="btn btn-info btn-set-active" data-id="${ps.id}" ${ps.id === activeId ? 'disabled' : ''}>
                                    Set Active
                                </button>
                                <button class="btn btn-info btn-edit" data-id="${ps.id}">Edit</button>
                                <button class="btn btn-secondary btn-delete" data-id="${ps.id}">Delete</button>
                            </div>
                        `;
                        powerStripsContainer.appendChild(item);
                    });
                    
                    // Add event listeners
                    powerStripsContainer.querySelectorAll('.btn-set-active').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const id = this.getAttribute('data-id');
                            await setActivePowerStrip(id);
                        });
                    });
                    
                    powerStripsContainer.querySelectorAll('.btn-edit').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            editPowerStrip(id, powerStrips);
                        });
                    });
                    
                    powerStripsContainer.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            deletePowerStrip(id);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading power strips:', error);
                powerStripsContainer.innerHTML = `<div class="error-message">Error loading power strips: ${error.message}</div>`;
            }
        }
        
        // Set active power strip
        async function setActivePowerStrip(id) {
            try {
                const response = await fetch('/api/config/active', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ power_strip_id: id })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadPowerStripsList();
                    if (window.PowerStripManager) {
                        await window.PowerStripManager.loadPowerStrips();
                        window.PowerStripManager.populateSelector();
                    }
                    if (typeof loadOutlets === 'function') {
                        await loadOutlets();
                    }
                    showMessage('Active power strip updated', 'success');
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }
        
        // Edit power strip
        function editPowerStrip(id, powerStrips) {
            const ps = powerStrips.find(p => p.id === id);
            if (!ps) return;
            
            document.getElementById('form-power-strip-id').value = ps.id;
            document.getElementById('form-power-strip-name').value = ps.name;
            document.getElementById('form-power-strip-ip').value = ps.ip_address;
            document.getElementById('form-title').textContent = 'Edit Power Strip';
            powerStripFormContainer.style.display = 'block';
        }
        
        // Delete power strip
        async function deletePowerStrip(id) {
            if (!confirm('Are you sure you want to delete this power strip?')) return;
            
            try {
                const response = await fetch(`/api/config/power-strips/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadPowerStripsList();
                    if (window.PowerStripManager) {
                        await window.PowerStripManager.loadPowerStrips();
                        window.PowerStripManager.populateSelector();
                    }
                    if (typeof loadOutlets === 'function') {
                        await loadOutlets();
                    }
                    showMessage('Power strip deleted', 'success');
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }
        
        // Open settings modal
        if (settingsBtn && settingsModal) {
            settingsBtn.addEventListener('click', async function() {
                await loadPowerStripsList();
                powerStripFormContainer.style.display = 'none';
                settingsModal.style.display = 'block';
                settingsMessage.innerHTML = '';
            });
        }
        
        // Close settings modal
        function closeSettingsModal() {
            if (settingsModal) {
                settingsModal.style.display = 'none';
                powerStripFormContainer.style.display = 'none';
                settingsMessage.innerHTML = '';
                powerStripForm.reset();
            }
        }
        
        if (settingsCloseBtn) {
            settingsCloseBtn.onclick = closeSettingsModal;
        }
        
        // Add power strip button
        if (btnAddPowerStrip) {
            btnAddPowerStrip.addEventListener('click', function() {
                powerStripForm.reset();
                document.getElementById('form-power-strip-id').value = '';
                document.getElementById('form-title').textContent = 'Add Power Strip';
                powerStripFormContainer.style.display = 'block';
            });
        }
        
        // Form cancel button
        if (formCancelBtn) {
            formCancelBtn.addEventListener('click', function() {
                powerStripFormContainer.style.display = 'none';
                powerStripForm.reset();
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == powerModal) {
                powerModal.style.display = 'none';
            }
            if (event.target == settingsModal) {
                closeSettingsModal();
            }
        };
        
        // Handle power strip form submission
        if (powerStripForm) {
            powerStripForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const id = document.getElementById('form-power-strip-id').value;
                const name = document.getElementById('form-power-strip-name').value.trim();
                const ipAddress = document.getElementById('form-power-strip-ip').value.trim();
                
                settingsMessage.innerHTML = '';
                
                const submitBtn = document.getElementById('form-submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                try {
                    let response;
                    if (id) {
                        // Update existing
                        response = await fetch(`/api/config/power-strips/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, ip_address: ipAddress })
                        });
                    } else {
                        // Add new
                        response = await fetch('/api/config/power-strips', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name, ip_address: ipAddress })
                        });
                    }
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        settingsMessage.innerHTML = `<div class="success-message">${data.message || 'Power strip saved successfully!'}</div>`;
                        
                        setTimeout(async () => {
                            await loadPowerStripsList();
                            powerStripFormContainer.style.display = 'none';
                            powerStripForm.reset();
                            if (window.PowerStripManager) {
                                await window.PowerStripManager.loadPowerStrips();
                                window.PowerStripManager.populateSelector();
                            }
                            if (typeof loadOutlets === 'function') {
                                await loadOutlets();
                            }
                        }, 1000);
                    } else {
                        settingsMessage.innerHTML = `<div class="error-message">Error: ${data.error}</div>`;
                    }
                } catch (error) {
                    settingsMessage.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        // DOM is already ready
        initializeApp();
    }
</script>
{% endblock %}

