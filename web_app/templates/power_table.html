
{% extends "base.html" %}

{% block content %}

<div class="power-table-container">
    <h1>Power Draw - All Outlets</h1>
    <div class="power-table-controls">
        <a href="/" class="btn btn-primary" id="back-btn" data-preserve-compact>Back to Home</a>
        <a href="/" class="btn btn-primary compact-back-btn" id="compact-back-btn" style="display: none;" data-preserve-compact>
            <span class="icon">‚Üê</span> Back
        </a>
        <button class="btn btn-info" onclick="manualRefresh()" style="margin-bottom: 20px;">
            <span class="icon">üîÑ</span> Refresh
        </button>
        <span id="refresh-countdown" class="refresh-countdown"></span>
    </div>
    
    <div id="power-table-loading" class="loading-message">
        <div class="spinner"></div>
        <p>Loading power data...</p>
    </div>
    
    <div id="power-table-error" class="error-message" style="display: none;"></div>
    
    <table id="power-table" class="power-table" style="display: none;">
        <thead>
            <tr>
                <th>Outlet #</th>
                <th>Name</th>
                <th>Voltage (V)</th>
                <th>Current (A)</th>
                <th>Power (W)</th>
                <th>Total Energy (kWh)</th>
            </tr>
        </thead>
        <tbody id="power-table-body">
        </tbody>
    </table>
</div>

<script>
    // Handle compact mode UI updates
    (function() {
        // Wait for CompactMode utility to load
        function initCompactMode() {
            if (typeof window.CompactMode === 'undefined') {
                setTimeout(initCompactMode, 50);
                return;
            }
            
            const isCompact = window.CompactMode.isEnabled();
            
            // Show/hide appropriate back button
            const compactBackBtn = document.getElementById('compact-back-btn');
            const regularBackBtn = document.getElementById('back-btn');
            
            if (isCompact) {
                if (compactBackBtn) compactBackBtn.style.display = 'inline-flex';
                if (regularBackBtn) regularBackBtn.style.display = 'none';
                
                // Update compact back button href to preserve compact mode
                if (compactBackBtn) {
                    compactBackBtn.href = window.CompactMode.getUrl('/', true);
                }
            } else {
                if (compactBackBtn) compactBackBtn.style.display = 'none';
                if (regularBackBtn) regularBackBtn.style.display = 'inline-flex';
            }
        }
        
        initCompactMode();
    })();
    
    // Auto-refresh interval variable
    let refreshInterval = null;
    let countdownInterval = null;
    let countdownSeconds = 10;
    
    // Update countdown display
    function updateCountdown() {
        const countdownEl = document.getElementById('refresh-countdown');
        if (countdownEl) {
            countdownEl.textContent = countdownSeconds;
        }
    }
    
    // Start countdown timer
    function startCountdown() {
        countdownSeconds = 10;
        updateCountdown();
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        countdownInterval = setInterval(function() {
            countdownSeconds--;
            updateCountdown();
            
            if (countdownSeconds <= 0) {
                countdownSeconds = 10;
            }
        }, 1000); // Update every second
    }
    
    // Manual refresh handler
    function manualRefresh() {
        loadPowerTable();
        startCountdown(); // Reset countdown on manual refresh
    }
    
    // Load power table on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('power_table.html: DOMContentLoaded fired, calling loadPowerTable()');
        loadPowerTable();
        startCountdown();
        
        // Set up auto-refresh every 10 seconds
        refreshInterval = setInterval(function() {
            console.log('power_table.html: Auto-refreshing power table...');
            loadPowerTable();
            startCountdown(); // Reset countdown after refresh
        }, 10000); // 10 seconds
    });
    
    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    });
    
    async function loadPowerTable() {
        console.log('loadPowerTable: Function called');
        const loadingDiv = document.getElementById('power-table-loading');
        const errorDiv = document.getElementById('power-table-error');
        const table = document.getElementById('power-table');
        const tableBody = document.getElementById('power-table-body');
        
        console.log('loadPowerTable: DOM elements found:', {
            loadingDiv: !!loadingDiv,
            errorDiv: !!errorDiv,
            table: !!table,
            tableBody: !!tableBody
        });
        
        if (!loadingDiv || !errorDiv || !table || !tableBody) {
            console.error('loadPowerTable: Required DOM elements not found!');
            return;
        }
        
        // Show loading state
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        table.style.display = 'none';
        tableBody.innerHTML = '';
        
        try {
            console.log('loadPowerTable: Fetching /api/outlets/all/power...');
            
            // Create a timeout promise
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('Request timeout after 15 seconds')), 15000);
            });
            
            // Race between fetch and timeout
            const response = await Promise.race([
                fetch('/api/outlets/all/power'),
                timeoutPromise
            ]);
            
            console.log('loadPowerTable: Response status:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('loadPowerTable: Received data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load power data');
            }
            
            const powerData = data.power_data;
            console.log('loadPowerTable: Power data:', powerData);
            
            if (!powerData || powerData.length === 0) {
                throw new Error('No power data available');
            }
            
            let totalPower = 0;
            console.log('loadPowerTable: Starting to populate table with', powerData.length, 'outlets');
            
            // Clear and populate table
            powerData.forEach((power, index) => {
                try {
                    console.log(`loadPowerTable: Processing outlet ${index + 1}/${powerData.length}:`, power);
                    const row = document.createElement('tr');
                    
                    if (power.error) {
                        row.innerHTML = `
                            <td>${power.outlet_num}</td>
                            <td>${escapeHtml(power.outlet_name)}</td>
                            <td colspan="4" class="error-cell">Error: ${escapeHtml(power.error)}</td>
                        `;
                    } else {
                        const powerValue = power.power !== undefined ? power.power : 0;
                        row.innerHTML = `
                            <td>${power.outlet_num}</td>
                            <td>${escapeHtml(power.outlet_name)}</td>
                            <td>${power.voltage !== undefined ? power.voltage.toFixed(2) : 'N/A'}</td>
                            <td>${power.current !== undefined ? power.current.toFixed(3) : 'N/A'}</td>
                            <td><strong>${power.power !== undefined ? power.power.toFixed(2) : 'N/A'}</strong></td>
                            <td>${power.total !== undefined ? power.total.toFixed(3) : 'N/A'}</td>
                        `;
                        if (power.power !== undefined) {
                            totalPower += powerValue;
                        }
                    }
                    tableBody.appendChild(row);
                    console.log(`loadPowerTable: Added row for outlet ${power.outlet_num}`);
                } catch (rowError) {
                    console.error(`loadPowerTable: Error processing outlet ${power.outlet_num}:`, rowError);
                }
            });
            
            console.log('loadPowerTable: Finished processing outlets, totalPower:', totalPower);
            console.log('loadPowerTable: Table body children count:', tableBody.children.length);
            
            const totalRow = document.createElement('tr');
            totalRow.innerHTML = `
                <td colspan="4"><strong>Total:</strong></td>
                <td><strong>${totalPower.toFixed(2)}</strong></td>
                <td></td>
            `;
            tableBody.appendChild(totalRow);
            
            // Show table, hide loading
            console.log('loadPowerTable: Successfully populated table with', powerData.length, 'outlets');
            console.log('loadPowerTable: Hiding loading div, showing table');
            console.log('loadPowerTable: loadingDiv.style.display before:', loadingDiv.style.display);
            console.log('loadPowerTable: table.style.display before:', table.style.display);
            
            loadingDiv.style.display = 'none';
            table.style.display = 'table';
            
            console.log('loadPowerTable: loadingDiv.style.display after:', loadingDiv.style.display);
            console.log('loadPowerTable: table.style.display after:', table.style.display);
            console.log('loadPowerTable: Table should now be visible');
            
        } catch (error) {
            console.error('loadPowerTable: Error occurred:', error);
            console.error('loadPowerTable: Error stack:', error.stack);
            loadingDiv.style.display = 'none';
            errorDiv.textContent = `Error: ${error.message}`;
            errorDiv.style.display = 'block';
            console.error('loadPowerTable: Error displayed to user');
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Make sure loadPowerTable is accessible globally for onclick handler
    window.loadPowerTable = loadPowerTable;
    window.manualRefresh = manualRefresh;
    console.log('power_table.html: loadPowerTable function defined and assigned to window');
</script>

<style>
    .power-table-container {
        background: var(--card-bg);
        padding: 30px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }
    
    .power-table-container h1 {
        margin-bottom: 20px;
        color: var(--text-primary);
    }
    
    .power-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .power-table th {
        background: var(--primary-color);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .power-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .power-table tbody tr:hover {
        background: var(--bg-color);
    }
    
    .power-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .error-cell {
        color: var(--secondary-color);
        font-style: italic;
    }
    
    .refresh-countdown {
        display: inline-flex;
        align-items: center;
        padding: 0 10px;
        font-size: 1.2em;
        font-weight: 600;
        color: var(--text-secondary);
        margin-left: 10px;
    }
    
    body.compact-mode .refresh-countdown {
        font-size: 0.9em;
        padding: 0 5px;
        margin-left: 5px;
    }
    
    @media (max-width: 768px) {
        .power-table {
            font-size: 0.9em;
        }
        
        .power-table th,
        .power-table td {
            padding: 8px;
        }
    }
</style>

{% endblock %}